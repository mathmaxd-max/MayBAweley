---
import type { Book } from '../data/types';
import { shouldShowRating, getDisplayRating } from '../data/books';
import { formatRating, formatDate } from '../utils/formatting';

interface Props {
  book: Book;
}

const { book } = Astro.props;
const rating = getDisplayRating(book);
const lovelybooks = book.social_proof?.lovelybooks;

if (!rating || !rating.source_url) {
  return null;
}
if (rating.stars < 4 && rating.ratings_count < 1000) {
  return null;
}

const isAmazon = !!book.social_proof?.amazon;
const label = isAmazon ? 'Amazon' : 'LovelyBooks';
const showStars = shouldShowRating(book);
const countText = `${rating.ratings_count.toLocaleString('de-DE')} Bewertungen`;
---

<div class="mt-4">
  <a
    href={rating.source_url}
    target="_blank"
    rel="noopener noreferrer"
    class="inline-flex items-center gap-2 text-sm text-text/80 hover:text-primary transition-colors"
  >
    <span class="font-semibold">{label}:</span>
    {showStars && (
      <span class="flex items-center gap-1">
        <span>{formatRating(rating.stars)}</span>
        <span class="text-accent">★</span>
      </span>
    )}
    <span>({countText})</span>
    {showStars && !isAmazon && lovelybooks?.captured_on && (
      <span class="text-text/60">— Stand: {formatDate(lovelybooks.captured_on)}</span>
    )}
  </a>
</div>
